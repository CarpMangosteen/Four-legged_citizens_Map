<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="initial-scale=1.0, user-scalable=no, width=device-width"
    />
    <title>地图标记示例</title>
    <style>
      html, body, #container { width: 100%; height: 100%; margin: 0; padding: 0; }
      .custom-content-marker { position: relative; width: 25px; height: 34px; }
      .custom-content-marker img { width: 100%; height: 100%; }
      .custom-content-marker .close-btn {
        position: absolute; top: -6px; right: -8px; width: 15px; height: 15px;
        font-size: 12px; background: #ccc; border-radius: 50%; color: #fff;
        text-align: center; line-height: 15px; box-shadow: -1px 1px 1px rgba(10, 10, 10, .2);
      }
      .custom-content-marker .close-btn:hover { background: #666; }
      /* 表单样式 */
      #form {
        margin: 20px;
        padding: 10px;
        background-color: #f4f4f4;
      }
      #form input {
        margin: 5px 0;
        padding: 8px;
        width: 200px;
      }
    </style>
    <title>HELLO, AMAP!</title>
    <style>
      html,
      body,
      #container {
        width: 100%;
        height: 100%;
      }
    </style>
    <!-- 配置安全密钥 -->
    <script type="text/javascript">
      window._AMapSecurityConfig = {
        securityJsCode: "338ac5cccabe0e9873dcd449ba73532e", // 替换为您申请的安全密钥
      };
    </script>
    <!-- 加载高德地图 JS API -->
    <script src="https://webapi.amap.com/loader.js"></script>
  </head>
  <body>
    <!-- 地图容器 -->
    <div id="container"></div>

    <!-- 表单部分 -->
    <div id="form">
        <label>经纬度 (lng, lat): </label>
        <input id="lng" type="text" placeholder="经度" />
        <input id="lat" type="text" placeholder="纬度" />
        <br />
        <label>图片 URL: </label>
        <input id="image" type="text" placeholder="图片链接" />
        <br />
        <button onclick="addMarker()">添加标记</button>
    </div>
    
    <!-- 加载地图并初始化 -->
    <script type="text/javascript">
      AMapLoader.load({
        key: "4f1a02778d43d4e88c5ed32aaad3f243", // 替换为您的应用key
        version: "2.0", // 加载 API 的版本
      })
        .then((AMap) => {
            // JS API 加载完成后，初始化地图
            const map = new AMap.Map("container", {
                viewMode: '2D', //默认使用 2D 模式
                center: [121.40590300000008, 31.226988000000016], // 设置地图中心点为北京
                zoom: 15, // 设置地图缩放级别
                mapStyle: "amap://styles/normal", //设置地图的显示样式
            });
            // 从 Flask 后端获取标记数据
            fetch("/get_markers")
            .then(response => response.json())
            .then(data => {
                data.markers.forEach(markerData => {
                const markerContent = `
                    <div class="custom-content-marker">
                    <img src="${markerData.image}" />
                    <div class="close-btn" onclick="clearMarker(${markerData.id})">X</div>
                    </div>`;
                const marker = new AMap.Marker({
                    position: markerData.position,
                    content: markerContent,
                    offset: new AMap.Pixel(-13, -30),
                });
                map.add(marker);
                });
            });

            // 删除标记的函数
            window.clearMarker = function(id) {
            fetch(`/delete_marker/${id}`, { method: "DELETE" })
                .then(() => {
                alert("标记已删除！");
                window.location.reload(); // 刷新页面
                });
            };
            // 添加标记的函数
            window.addMarker = function addMarker() {
            const lng = document.getElementById("lng").value;
            const lat = document.getElementById("lat").value;
            const image = document.getElementById("image").value;
        
            fetch("/add_marker", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ position: [parseFloat(lng), parseFloat(lat)], image }),
            })
                .then(response => response.json())
                .then(data => {
                if (data.success) {
                    alert("标记已添加！");
                    window.location.reload(); // 刷新页面以更新标记
                }
                });
            }
        })
        .catch((e) => {
          console.error(e); // 错误提示
        });
    </script>
  </body>
</html>
